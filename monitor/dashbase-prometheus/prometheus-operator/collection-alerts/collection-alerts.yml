apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    clusterName: '{{ $labels.clusterName }}'
    regionName: '{{ $labels.regionName }}'
  labels:
    role: dashbase-collection-rules
  name: dashbase-collection-rules
spec:
  groups:
    - name: dashbase-collection
      rules:
        - expr: http_filebeat_harvester_running > 3000
            annotations:
              summary: "Filebeat harvesters of table {{ $labels.table }}  greater than 3000 on {{ $labels.host }}"
              description: "Filebeat on {{ $labels.host }} has more than 3000 harvesters and is backed up. Check Dashbase for table {{ $labels.table }} ingest issues."
            for: 5m
            alert: filebeat_harvester_running
        - expr: rate(http_libbeat_output_events_dropped[5m])/rate(http_libbeat_output_events_total[5m]) > 0.01
            annotations:
              summary: "Filebeat ingesting table {{ $labels.table }} on {{ $labels.host }} is dropping events"
              description: "Filebeat ingesting table {{ $labels.table }} on {{ $labels.host }} is dropping events. Check the Filebeat logs for more information."
            labels:
              severity: critical
            for: 5m
            alert: filebeat_events_dropped
        - expr: rate(http_filebeat_harvester_skipped[5m])  > 0
            annotations:
              summary: "Filebeat ingesting table {{ $labels.table }} is backed up on {{ $labels.host }}"
              description: "Filebeat on {{ $labels.host }} is backed up and skipping log files. Check Dashbase for table {{ $labels.table }} ingest issues."
            labels:
              severity: critical
            for: 5m
            alert: filebeat_harvester_skipped
        - expr: rate(http_beat_info_uptime_ms[15m]) == 0
            annotations:
              summary: "Missing Filebeat metrics of table {{ $labels.table }} from '{{ $labels.host }}'"
              description: "No Filebeat metrics of table {{ $labels.table }} received from '{{ $labels.host }}' in the last 15 minutes. Please check the Filebeat running on this host or if this was intentional, delete the corresponding group from Pushgateway."
            labels:
              severity: critical
            for: 5m
            alert: missing_filebeat_metrics
        - expr: rate(nightwatch_metric_run_spent_time_nanosecond[15m]) == 0
            annotations:
              summary: "Missing NightWatch metrics from '{{ $labels.host }}'"
              description: "No NightWatch metrics received from '{{ $labels.host }}' in the last 15 minutes. Please check NightWatch on this host or if this was intentional, delete the corresponding group from Pushgateway."
            labels:
              severity: critical
            for: 5m
            alert: missing_nightwatch_metrics
        - expr: rate(push_time_seconds[15m]) == 0
            annotations:
              summary: "Missing Telegraf metrics from '{{ $labels.exported_instance }}'"
              description: "No Telegraf metrics received from '{{ $labels.exported_instance }}' in the last 15 minutes. Please check Telegraf on this host or if this was intentional, delete the corresponding group from Pushgateway."
            labels:
              severity: critical
            for: 5m
            alert: missing_telegraf_metrics
        - expr:  http_filebeat_harvester_running == 0 and on(host) rate(nightwatch_metric_file_append_total_size[5m]) > 0
            annotations:
              summary: "Filebeat ingesting table {{ $labels.table }} on '{{ $labels.host }}' is not harvesting logs"
              description: "Filebeat ingesting table {{ $labels.table }} on '{{ $labels.host }}' is not harvesting logs. Check the Filebeat logs for more information and restart the process."
            labels:
              severity: critical
            for: 5m
            alert: filebeat_not_harvesting
